{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Stats -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Stato Bot</h6>
                    <p id="bot-status" class="stat-value">--</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Posizioni Attive</h6>
                    <p id="active-positions" class="stat-value">--</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">PnL Realized (Sessione)</h6>
                    <p id="realized-pnl" class="stat-value">--</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">PnL Unrealized</h6>
                    <p id="unrealized-pnl" class="stat-value">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Posizioni Attive -->
    <div class="row mt-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i> Posizioni Attive</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry Price</th>
                                    <th>Mark Price</th>
                                    <th>Unrealized PnL</th>
                                    <th>Margin</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trades Recenti & Logs -->
    <div class="row mt-4">
        <div class="col-md-7">
            <div class="card">
                 <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i> Trades Recenti</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                         <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Price</th>
                                    <th>Size</th>
                                </tr>
                            </thead>
                            <tbody id="recent-trades-table">
                                <!-- Data from API -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i> Logs di Sistema</h5>
                </div>
                <div class="card-body log-container" id="logs-container">
                    <!-- Logs will be populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatCurrency(value) {
        if (typeof value !== 'number') return '--';
        const className = value >= 0 ? 'text-success-custom' : 'text-danger-custom';
        return `<span class="${className}">${value.toFixed(2)} USDT</span>`;
    }

    function updateDashboard() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('bot-status').textContent = data.status;
                document.getElementById('active-positions').textContent = data.active_positions_count;
                document.getElementById('realized-pnl').innerHTML = formatCurrency(data.total_realized_pnl);
                document.getElementById('unrealized-pnl').innerHTML = formatCurrency(data.total_unrealized_pnl);

                // Populate positions table
                const positionsTable = document.getElementById('positions-table');
                positionsTable.innerHTML = '';
                if (data.positions.length > 0) {
                    data.positions.forEach(p => {
                        const row = `
                            <tr>
                                <td>${p.symbol}</td>
                                <td><span class="${p.side === 'long' ? 'text-success-custom' : 'text-danger-custom'}">${p.side.toUpperCase()}</span></td>
                                <td>${p.quantity}</td>
                                <td>${p.entryPrice.toFixed(4)}</td>
                                <td>${p.markPrice.toFixed(4)}</td>
                                <td>${formatCurrency(p.unrealisedPnl)}</td>
                                <td>${(p.marginCost || 0).toFixed(2)} USDT</td>
                            </tr>`;
                        positionsTable.innerHTML += row;
                    });
                } else {
                    positionsTable.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nessuna posizione aperta.</td></tr>';
                }

                // Populate recent trades
                const tradesTable = document.getElementById('recent-trades-table');
                tradesTable.innerHTML = '';
                 if (data.recent_trades.length > 0) {
                    data.recent_trades.forEach(t => {
                        const ts = new Date(t.timestamp * 1000).toLocaleTimeString();
                        const row = `
                            <tr>
                                <td>${ts}</td>
                                <td>${t.symbol}</td>
                                <td><span class="${t.side === 'buy' ? 'text-success-custom' : 'text-danger-custom'}">${t.side.toUpperCase()}</span></td>
                                <td>${t.price}</td>
                                <td>${t.size}</td>
                            </tr>`;
                        tradesTable.innerHTML += row;
                    });
                } else {
                    tradesTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nessun trade recente.</td></tr>';
                }
            });

        fetch('/api/logs')
            .then(response => response.json())
            .then(logs => {
                const logsContainer = document.getElementById('logs-container');
                logsContainer.innerHTML = '';
                logs.forEach(log => {
                    const ts = new Date(log.timestamp * 1000).toLocaleTimeString();
                    const levelClass = log.level === 'ERROR' ? 'text-danger-custom' : (log.level === 'WARNING' ? 'text-warning' : '');
                    const logEntry = `
                        <div class="log-entry ${levelClass}">
                            <strong>[${ts}] [${log.module}]</strong> ${log.message}
                        </div>`;
                    logsContainer.innerHTML += logEntry;
                });
            });
    }

    setInterval(updateDashboard, 2000);
    updateDashboard();
</script>
{% endblock %}
