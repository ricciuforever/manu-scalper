{% extends "base.html" %}

{% block title %}Storico & Performance{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Performance Stats -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Total Realized PnL</h6>
                    <p id="total-pnl" class="stat-value">--</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Win Rate</h6>
                    <p id="win-rate" class="stat-value">--</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Total Closed Trades</h6>
                    <p id="total-trades" class="stat-value">--</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title text-muted">Benchmark (BTC)</h6>
                    <p id="benchmark-return" class="stat-value">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Equity Curve -->
    <div class="row mt-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i> Equity Curve</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="fetchHistory(event, 7)">7D</button>
                            <button type="button" class="btn btn-sm btn-outline-info active" onclick="fetchHistory(event, 30)">30D</button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="fetchHistory(event, 0)">All</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade History Table -->
    <div class="row mt-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-book me-2"></i> Storico Operazioni</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Close Time</th>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Price</th>
                                    <th>Size</th>
                                    <th>Fee</th>
                                </tr>
                            </thead>
                            <tbody id="history-table">
                                <!-- Data populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let equityChart = null;

    function formatCurrency(value, withSign = true) {
        if (typeof value !== 'number') return '--';
        const className = value >= 0 ? 'text-success-custom' : 'text-danger-custom';
        const sign = withSign && value >= 0 ? '+' : '';
        return `<span class="${className}">${sign}${value.toFixed(2)} USDT</span>`;
    }

    function formatPercent(value) {
         if (typeof value !== 'number') return '--';
        const className = value >= 0 ? 'text-success-custom' : 'text-danger-custom';
        const sign = value >= 0 ? '+' : '';
        return `<span class="${className}">${sign}${value.toFixed(2)}%</span>`;
    }

    function fetchHistory(event, days = 30) {
        // Update active button
        if (event) {
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        fetch(`/api/history?days=${days}`)
            .then(response => response.json())
            .then(data => {
                // Update stats
                document.getElementById('total-pnl').innerHTML = formatCurrency(data.stats.total_pnl);
                document.getElementById('win-rate').innerHTML = `${data.stats.win_rate.toFixed(2)}%`;
                document.getElementById('total-trades').textContent = data.stats.total_trades;
                document.getElementById('benchmark-return').innerHTML = formatPercent(data.stats.benchmark_return);

                // Populate history table
                const tableBody = document.getElementById('history-table');
                tableBody.innerHTML = '';
                 if (data.trades.length > 0) {
                    data.trades.forEach(t => {
                        const row = `
                            <tr>
                                <td>${new Date(t.timestamp * 1000).toLocaleString()}</td>
                                <td>${t.symbol}</td>
                                 <td><span class="${t.side === 'buy' ? 'text-success-custom' : 'text-danger-custom'}">${t.side.toUpperCase()}</span></td>
                                <td>${t.price}</td>
                                <td>${t.quantity}</td>
                                <td>-</td>
                            </tr>`;
                        tableBody.innerHTML += row;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nessun dato storico per il periodo selezionato.</td></tr>';
                }

                // Update chart
                const ctx = document.getElementById('equityChart').getContext('2d');
                if (equityChart) {
                    equityChart.destroy();
                }

                equityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Equity Curve (USDT)',
                                data: data.equity_curve.map(p => ({x: p.timestamp * 1000, y: p.equity})),
                                borderColor: '#00d4ff',
                                tension: 0.1,
                                yAxisID: 'y'
                            },
                             {
                                label: 'Benchmark (BTC %)',
                                data: data.benchmark_curve.map(p => ({x: p.timestamp * 1000, y: p.value})),
                                borderColor: '#ffc107',
                                borderDash: [5, 5],
                                tension: 0.1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Realized PnL (USDT)'},
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'Benchmark Return (%)'},
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            });
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => fetchHistory(null, 30));
</script>
{% endblock %}
